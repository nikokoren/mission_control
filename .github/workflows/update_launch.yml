name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          # UPDATED URL: hide_recent_previous=true
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=2&mode=detailed&hide_recent_previous=true&format=json" > upcoming.json
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          python3 - <<'EOF'
          import json
          import sys
          import random
          from datetime import datetime, timezone

          # --- CONFIG ---
          REPO_BASE = "https://raw.githubusercontent.com/nikokoren/mission_control/main"

          def load_json(filename):
              try:
                  with open(filename) as f:
                      data = json.load(f)
                      if "detail" in data: return None
                      if not data.get("results"): return None
                      return data["results"][0]
              except Exception:
                  return None

          upcoming = load_json("upcoming.json")
          previous = load_json("previous.json")

          if not upcoming and not previous:
              sys.exit(0)

          # --- TRIVIA BRAIN (TITANIUM EDITION) ---
          def get_rocket_fact(rocket_name):
              r_name = rocket_name.lower()
              general_facts = [
                  "Launch pad water deluge systems are primarily used for sound suppression to prevent acoustic waves from tearing the rocket apart.",
                  "To reach low Earth orbit, any rocket must travel at approximately 17,500 mph (28,000 km/h) sideways.",
                  "The Kármán line at 100km (62 miles) altitude is widely accepted as the boundary where space begins.",
                  "Rockets are mostly fuel; often over 85% of a launch vehicle's mass is propellant, leaving little room for payload.",
                  "Launch windows are strictly determined by orbital mechanics and collision avoidance requirements to hit a precise target.",
                  "The 'Max-Q' callout during launch refers to the moment of maximum dynamic pressure, where structural stress is highest.",
                  "Most rockets use a 'Gravity Turn', tilting slightly after liftoff to let gravity do the work of turning the rocket horizontal.",
                  "Hypergolic fuels ignite spontaneously upon contact with each other, making them reliable for restarting engines in space.",
                  "The 'pogo oscillation' is a dangerous vibration caused by fuel surging in the pipes, which can shake a rocket to pieces.",
                  "Specific Impulse (ISP) is the 'miles per gallon' of rocketry, measuring how efficiently an engine turns fuel into thrust."
              ]
              # (Paste your full Rocket Specific Facts list here if you have it saved locally, 
              # otherwise I will use a short fallback to keep this block copy-pasteable)
              facts = []
              
              if not facts: return random.choice(general_facts)
              return random.choice(facts + general_facts)

          # --- VISUAL BRAIN ---
          def get_rocket_image_url(rocket_name, status, landing_success, repo_url):
              r = rocket_name.lower()
              key = "generic"
              if "falcon 9" in r: key = "falcon9"
              elif "falcon heavy" in r: key = "falconheavy"
              elif "starship" in r: key = "starship"
              elif "electron" in r: key = "electron"
              elif "atlas" in r: key = "atlasv"
              elif "vulcan" in r: key = "vulcan"
              elif "delta" in r: key = "delta4"
              elif "sls" in r: key = "sls"
              elif "new glenn" in r: key = "newglenn"
              elif "ariane" in r: key = "ariane6"
              elif "soyuz" in r: key = "soyuz"
              elif "long march" in r: key = "cz_classic"
              elif "h3" in r: key = "h3"
              elif "vega" in r: key = "vega"
              elif "pslv" in r: key = "pslv"
              elif "antares" in r: key = "antares"
              elif "minotaur" in r: key = "minotaur"
              elif "firefly" in r: key = "firefly"
              
              suffix = "_idle"
              if status == "In Flight" or status == "AWAITING CONFIRMATION": suffix = "_ascent"
              elif status in ["Success", "Failure", "Partial Failure"]:
                  if landing_success and key in ["falcon9", "falconheavy", "starship", "newglenn"]: suffix = "_landed"
                  else: key, suffix = "empty", ""
              
              if key == "empty": return f"{repo_url}/rockets/empty.png"
              return f"{repo_url}/rockets/{key}{suffix}.png"

          # --- COUNTDOWN ---
          def get_countdown(dt_event):
              now = datetime.now(timezone.utc)
              diff = dt_event - now
              if diff.total_seconds() < 0: return "T- 00d 00h 00m"
              days = diff.days
              hours, remainder = divmod(diff.seconds, 3600)
              minutes, _ = divmod(remainder, 60)
              return f"T- {days:02}d {hours:02}h {minutes:02}m"

          # --- MAIN LOGIC ---
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          target = upcoming
          mode = "PRE_LAUNCH"

          if previous and upcoming:
              prev_dt = parse_time(previous["net"])
              next_dt = parse_time(upcoming["net"])
              hours_since = (now - prev_dt).total_seconds() / 3600
              hours_until = (next_dt - now).total_seconds() / 3600
              if hours_since < 12 and hours_until > 4:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          if target:
              target_dt = parse_time(target["net"])
              seconds_since_t0 = (now - target_dt).total_seconds()
              
              # API STATUS CHECK
              api_status = target["status"]["abbrev"]
              is_final = api_status in ["Success", "Failure", "Partial Failure", "In Flight"]
              
              if is_final:
                  mode = "POST_LAUNCH"
              elif seconds_since_t0 > 600:
                  mode = "POST_LAUNCH"
                  target["status"]["abbrev"] = "PENDING"
                  target["status"]["name"] = "AWAITING CONFIRMATION"

              mission_context = "COMMERCIAL"
              if target.get("program") and len(target["program"]) > 0:
                  mission_context = target["program"][0]["name"]
              elif target.get("mission") and target["mission"].get("type"):
                  mission_context = target["mission"]["type"]

              # --- NAME CLEANER ---
              def clean_name(name):
                  n = name.lower()
                  if "china aerospace" in n: return "CASC"
                  if "korea aerospace" in n: return "KARI" # Added KARI
                  if "arianespace" in n: return "Arianespace" # Ensure capitalization
                  if "spacex" in n: return "SpaceX"
                  if "nasa" in n: return "NASA"
                  if "united launch alliance" in n: return "ULA"
                  if "roscosmos" in n: return "Roscosmos"
                  if "indian space" in n: return "ISRO"
                  if "japan aerospace" in n: return "JAXA"
                  if "european space" in n: return "ESA"
                  if "rocket lab" in n: return "Rocket Lab"
                  if "blue origin" in n: return "Blue Origin"
                  if "northrop" in n: return "Northrop"
                  return name

              provider = clean_name(target["launch_service_provider"]["name"])
              
              agency = "" 
              if target.get("mission") and target.get("mission", {}).get("agencies"):
                  raw_agency = target["mission"]["agencies"][0]["name"]
                  cleaned = clean_name(raw_agency)
                  if cleaned != provider: agency = cleaned

              # --- DESCRIPTION DIET (250 chars) ---
              raw_mission_desc = ""
              if target.get("mission") and target["mission"].get("description"):
                  desc = target["mission"]["description"]
                  if "No description" not in desc and "TBD" not in desc:
                      raw_mission_desc = desc
              
              raw_program_desc = ""
              if target.get("program") and len(target["program"]) > 0:
                  p_desc = target["program"][0].get("description", "")
                  if "No description" not in p_desc: raw_program_desc = p_desc

              image_url = ""
              if target.get("mission_patches"): image_url = target["mission_patches"][0]["image_url"]
              elif target.get("launch_service_provider"): image_url = target["launch_service_provider"].get("logo_url", "")

              pad = target["pad"]["name"].replace("Space Launch Complex ", "SLC-").replace("Launch Complex ", "LC-")
              if pad.isdigit(): pad = f"Pad {pad}"
              loc = target["pad"]["location"]["name"].split(",")[0].strip()
              country = target["pad"]["location"].get("country_code", "")
              location_str = f"{pad} @ {loc}"
              if country: location_str += f", {country}"

              stage = {}
              if target.get("rocket", {}).get("launcher_stage"):
                  s_list = target["rocket"]["launcher_stage"]
                  if s_list: stage = s_list[0]
              
              landing = stage.get("landing") or {}
              attempt = landing.get("attempt")
              success = landing.get("success")
              l_loc = landing.get("location", {}).get("name", "Unknown")
              l_loc = l_loc.replace("Of Course I Still Love You", "OCISLY").replace("Just Read The Instructions", "JRTI")
              
              flight_n = stage.get("launcher_flight_number")

              footer_left = ""
              footer_right = ""
              if attempt is not True:
                  footer_right = "Single-use configuration. No recovery planned."
              else:
                  if mode == "PRE_LAUNCH":
                      if flight_n: footer_left = f"Booster flight #{flight_n}."
                      else: footer_left = "Booster identity classified."
                      if l_loc == "Unknown": footer_right = "Recovery planned (Location TBD)."
                      else: footer_right = f"Targeting recovery at {l_loc}."
                  else:
                      footer_left = ""
                      if target["status"]["abbrev"] == "PENDING": footer_right = "Launch window open. Status pending."
                      elif success: footer_right = f"SUCCESS: Landed at {l_loc}."
                      elif success is False: footer_right = f"FAILURE: Missed {l_loc}."
                      else: footer_right = f"Landing pending at {l_loc}."

              rocket_name = target["rocket"]["configuration"]["name"]
              try: the_fact = get_rocket_fact(rocket_name)
              except: the_fact = "Rockets are cool."
              
              # Use the Status Abbreviation (e.g. "Success", "In Flight", "PENDING")
              # instead of the long name so the image logic matches correctly.
              
              visual_status_code = target["status"]["abbrev"]
              
              # Handle our custom "Limbo" state override
              if target["status"]["abbrev"] == "PENDING":
                   visual_status_code = "PENDING"

              rocket_visual_url = get_rocket_image_url(
                  rocket_name, 
                  visual_status_code, 
                  landing_success, 
                  REPO_BASE
              )

              m_name = target["name"].split(" | ")[-1]
              if "Unknown Payload" in m_name: m_name = rocket_name

              output = {
                  "mode": mode,
                  "name": m_name,
                  "context": mission_context.upper(),
                  "agency": agency,
                  "provider": provider,
                  "location_str": location_str,
                  "date": target["net"],
                  "countdown": get_countdown(parse_time(target["net"])),
                  "status": target["status"]["abbrev"],
                  "image": image_url,
                  # DIET APPLIED HERE:
                  "description": (raw_mission_desc or "").replace("\n", " ")[0:280], 
                  "program_description": (raw_program_desc or "").replace("\n", " ")[0:280],
                  "rocket": rocket_name,
                  "orbit": target["mission"]["orbit"]["name"] if target.get("mission") and target.get("mission", {}).get("orbit") else "TBD",
                  "footer_left": footer_left,
                  "footer_right": footer_right,
                  "rocket_fact": the_fact,
                  "rocket_visual": vis_url
              }

              with open("launch.json", "w") as f:
                  json.dump(output, f, separators=(',', ':'))
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
