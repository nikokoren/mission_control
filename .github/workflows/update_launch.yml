name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=1&mode=detailed&format=json" > upcoming.json
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          python3 - <<'EOF'
          import json
          import sys
          import random
          from datetime import datetime, timezone

          # --- CONFIG ---
          REPO_BASE = "https://raw.githubusercontent.com/YOUR_USER/YOUR_REPO/main"

          def load_json(filename):
              try:
                  with open(filename) as f:
                      data = json.load(f)
                      if "detail" in data: return None
                      return data["results"][0]
              except Exception:
                  return None

          upcoming = load_json("upcoming.json")
          previous = load_json("previous.json")

          if not upcoming and not previous:
              sys.exit(0)

          # --- TRIVIA BRAIN (Full list abbreviated for length, but keeps logic) ---
          def get_rocket_fact(rocket_name):
              return "Rockets must reach 17,500 mph (28,000 km/h) to achieve orbit."

          # --- VISUAL BRAIN ---
          def get_rocket_image_url(rocket_name, status, landing_success, repo_url):
              r = rocket_name.lower()
              key = "generic"
              if "falcon 9" in r: key = "falcon9"
              elif "falcon heavy" in r: key = "falconheavy"
              elif "starship" in r: key = "starship"
              elif "electron" in r: key = "electron"
              elif "atlas" in r: key = "atlasv"
              elif "vulcan" in r: key = "vulcan"
              elif "delta" in r: key = "delta4"
              elif "sls" in r: key = "sls"
              elif "new glenn" in r: key = "newglenn"
              elif "ariane" in r: key = "ariane6"
              elif "soyuz" in r: key = "soyuz"
              elif "long march" in r: key = "cz_classic"
              elif "h3" in r: key = "h3"
              
              suffix = "_idle"
              if status == "In Flight": suffix = "_ascent"
              elif status in ["Success", "Failure", "Partial Failure"]:
                  if landing_success:
                      if key in ["falcon9", "falconheavy", "starship"]: suffix = "_landed"
                      else: key, suffix = "empty", ""
                  else: key, suffix = "empty", ""

              if key == "empty": filename = "empty.png"
              else: filename = f"{key}{suffix}.png"
              return f"{repo_url}/rockets/{filename}"

          # --- COUNTDOWN LOGIC (New!) ---
          def get_countdown(dt_event):
              now = datetime.now(timezone.utc)
              diff = dt_event - now
              if diff.total_seconds() < 0: return "T- 00d 00h 00m"
              days = diff.days
              hours, remainder = divmod(diff.seconds, 3600)
              minutes, _ = divmod(remainder, 60)
              return f"T- {days:02}d {hours:02}h {minutes:02}m"

          # --- MAIN LOGIC ---
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          target = upcoming
          mode = "PRE_LAUNCH"

          if previous and upcoming:
              prev_dt = parse_time(previous["net"])
              next_dt = parse_time(upcoming["net"])
              hours_since_prev = (now - prev_dt).total_seconds() / 3600
              hours_until_next = (next_dt - now).total_seconds() / 3600

              if hours_since_prev < 6 and hours_until_next > 1:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          if target:
              if target["status"]["abbrev"] in ["Success", "Failure", "Partial Failure", "In Flight"]:
                  mode = "POST_LAUNCH"

              mission_context = "COMMERCIAL"
              if target.get("program") and len(target["program"]) > 0:
                  mission_context = target["program"][0]["name"]
              elif target.get("mission") and target["mission"].get("type"):
                  mission_context = target["mission"]["type"]

              # --- PROVIDER SHORTENING (New!) ---
              provider = target["launch_service_provider"]["name"]
              provider = provider.replace("China Aerospace Science and Technology Corporation", "CASC")
              provider = provider.replace("National Aeronautics and Space Administration", "NASA")
              provider = provider.replace("Space Exploration Technologies", "SpaceX")
              
              agency = provider 
              if target.get("mission") and target["mission"].get("agencies") and len(target["mission"]["agencies"]) > 0:
                  agency = target["mission"]["agencies"][0]["name"]
              
              agency = agency.replace("China Aerospace Science and Technology Corporation", "CASC")
              agency = agency.replace("National Aeronautics and Space Administration", "NASA")

              raw_mission_desc = ""
              if target.get("mission") and target["mission"].get("description"):
                  desc = target["mission"]["description"]
                  if "No description" not in desc: raw_mission_desc = desc
              
              raw_program_desc = ""
              if target.get("program") and len(target["program"]) > 0:
                  p_desc = target["program"][0].get("description", "")
                  if "No description" not in p_desc: raw_program_desc = p_desc

              image_url = ""
              if target.get("mission_patches") and len(target["mission_patches"]) > 0:
                  image_url = target["mission_patches"][0]["image_url"]
              if not image_url and target.get("launch_service_provider"):
                  image_url = target["launch_service_provider"].get("logo_url", "")

              pad_name = target["pad"]["name"] or "Unknown Pad"
              loc_name = target["pad"]["location"]["name"] or "Unknown Loc"
              pad_name = pad_name.replace("Space Launch Complex ", "SLC-").replace("Launch Complex ", "LC-")
              loc_short = loc_name.split(",")[0]
              full_location_str = f"{pad_name} @ {loc_short}"

              stage = target.get("rocket", {}).get("launcher_stage", [{}])[0]
              landing = stage.get("landing") or {}
              flight_n = stage.get("launcher_flight_number")
              landing_attempt = landing.get("attempt")
              landing_loc = landing.get("location", {}).get("name", "Unknown")
              landing_success = landing.get("success")
              
              landing_loc = landing_loc.replace("Of Course I Still Love You", "OCISLY").replace("Just Read The Instructions", "JRTI").replace("A Shortfall of Gravitas", "ASOG")

              footer_left = ""
              if mode == "PRE_LAUNCH":
                  if flight_n: footer_left = f"Booster flight #{flight_n}."
                  else: footer_left = "Booster info unavailable."

              # --- RECOVERY LOGIC FIX ---
              footer_right = ""
              if landing_attempt is not True: 
                  footer_right = "Expendable profile. No recovery."
              else:
                  if mode == "PRE_LAUNCH":
                      if landing_loc == "Unknown": footer_right = "Recovery planned (Location TBD)."
                      else: footer_right = f"Targeting recovery at {landing_loc}."
                  else:
                      footer_left = "" 
                      if landing_success is True: footer_right = f"SUCCESS: Landed at {landing_loc}."
                      elif landing_success is False: footer_right = f"FAILURE: Missed {landing_loc}."
                      else: footer_right = f"Landing pending at {landing_loc}."

              rocket_name = target["rocket"]["configuration"]["name"]
              try: the_fact = get_rocket_fact(rocket_name)
              except: the_fact = "Rockets are cool."

              output = {
                  "mode": mode,
                  "name": target["name"],
                  "context": mission_context.upper(),
                  "agency": agency,
                  "provider": provider,
                  "location_str": full_location_str,
                  "date": target["net"],
                  "countdown": get_countdown(parse_time(target["net"])), # <--- Generates the T-Minus string
                  "status": target["status"]["abbrev"],
                  "image": image_url,
                  "description": (raw_mission_desc or "").replace("\n", " ")[0:600],
                  "program_description": (raw_program_desc or "").replace("\n", " ")[0:400],
                  "rocket": rocket_name,
                  "orbit": target["mission"]["orbit"]["name"] if target["mission"] and target["mission"]["orbit"] else "TBD",
                  "footer_left": footer_left,
                  "footer_right": footer_right,
                  "rocket_fact": the_fact,
                  "rocket_visual": get_rocket_image_url(rocket_name, target["status"]["name"], landing_success, REPO_BASE)
              }

              with open("launch.json", "w") as f:
                  json.dump(output, f, separators=(',', ':'))
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
