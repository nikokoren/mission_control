name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/10 * * * *' # Run every 4 hours normally
  workflow_dispatch:      # Run manually

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          # 1. Fetch the NEXT launch
          curl -s "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=1&mode=detailed&format=json" > upcoming.json
          
          # 2. Fetch the PREVIOUS launch (to check if we just missed one)
          curl -s "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          # 3. RUN THE DECISION LOGIC (Python is cleaner for this math than Shell)
          python3 -c '
          import json
          from datetime import datetime, timezone, timedelta

          # Load Data
          with open("upcoming.json") as f:
              upcoming = json.load(f)["results"][0]
          with open("previous.json") as f:
              previous = json.load(f)["results"][0]

          # Helper to parse time
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          prev_date = parse_time(previous["net"])
          next_date = parse_time(upcoming["net"])

          # LOGIC:
          # 1. If previous launch was less than 6 hours ago, SHOW PREVIOUS (Results mode)
          # 2. UNLESS the next launch is imminent (less than 1 hour away), then SHOW NEXT (Hype mode)
          
          hours_since_prev = (now - prev_date).total_seconds() / 3600
          hours_until_next = (next_date - now).total_seconds() / 3600

          if hours_since_prev < 6 and hours_until_next > 1:
              target = previous
              mode = "POST_LAUNCH"
          else:
              target = upcoming
              mode = "PRE_LAUNCH"

          # Extract Fields
          # We check stage retreival (landing) specifically for the first stage
          stage = target.get("rocket", {}).get("launcher_stage", [{}])[0]
          landing = stage.get("landing", {})
          
          landing_success = "Pending"
          if landing.get("attempt") == True:
              if landing.get("success") == True: landing_success = "SUCCESS"
              elif landing.get("success") == False: landing_success = "FAILED"
              else: landing_success = "Attempting..."
          else:
              landing_success = "No Attempt"

          output = {
              "mode": mode,
              "name": target["name"],
              "provider": target["launch_service_provider"]["name"],
              "pad": target["pad"]["location"]["name"],
              "date": target["net"],
              "status": target["status"]["abbrev"],
              "description": (target["mission"]["description"] or "No description")[0:250] + "...",
              "rocket": target["rocket"]["configuration"]["name"],
              "orbit": target["mission"]["orbit"]["name"] if target["mission"]["orbit"] else "TBD",
              
              # Post-Launch Specifics
              "landing_status": landing_success,
              "landing_loc": landing.get("location", {}).get("name", "N/A"),
              "flight_proven": stage.get("reused", False)
          }

          with open("launch.json", "w") as f:
              json.dump(output, f, indent=2)
          '

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
