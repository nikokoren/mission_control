name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          # 1. Fetch NEXT launch (Silent -s but show errors -S)
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=1&mode=detailed&format=json" > upcoming.json
          
          # 2. Fetch PREVIOUS launch
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          # 3. DEBUG: Check if files fetched correctly (Prints first 5 lines)
          echo "--- DEBUG: upcoming.json head ---"
          head -n 5 upcoming.json
          echo "--- DEBUG: previous.json head ---"
          head -n 5 previous.json

          # 4. Python Logic (Using Heredoc to prevent Syntax Errors)
          python3 - <<'EOF'
          import json
          import sys
          from datetime import datetime, timezone

          def load_json(filename):
              try:
                  with open(filename) as f:
                      data = json.load(f)
                      if "detail" in data: return None
                      return data["results"][0]
              except Exception:
                  return None

          upcoming = load_json("upcoming.json")
          previous = load_json("previous.json")

          if not upcoming and not previous:
              sys.exit(1)

          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          target = upcoming
          mode = "PRE_LAUNCH"

          # 1. DECISION LOGIC
          if previous and upcoming:
              prev_date = parse_time(previous["net"])
              next_date = parse_time(upcoming["net"])
              hours_since_prev = (now - prev_date).total_seconds() / 3600
              hours_until_next = (next_date - now).total_seconds() / 3600

              if hours_since_prev < 6 and hours_until_next > 1:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          if target:
              # Zombie Fix
              if target["status"]["abbrev"] in ["Success", "Failure", "Partial Failure"]:
                  mode = "POST_LAUNCH"

              # 2. CONTEXT & AGENCY
              mission_context = "Commercial"
              if target.get("program") and len(target["program"]) > 0:
                  mission_context = target["program"][0]["name"]
              elif target.get("mission") and target["mission"].get("type"):
                  mission_context = target["mission"]["type"]

              agency = target["launch_service_provider"]["name"] 
              if target.get("mission") and target["mission"].get("agencies") and len(target["mission"]["agencies"]) > 0:
                  agency = target["mission"]["agencies"][0]["name"]
              
              agency = agency.replace("National Aeronautics and Space Administration", "NASA")
              agency = agency.replace("Space Exploration Technologies", "SpaceX")

              # 3. TEXT FIELDS
              raw_mission_desc = "No mission description."
              if target.get("mission") and target["mission"].get("description"):
                  raw_mission_desc = target["mission"]["description"]

              raw_program_desc = "No program details."
              if target.get("program") and len(target["program"]) > 0:
                  raw_program_desc = target["program"][0].get("description", "No program description.")

              # 4. IMAGE LOGIC (Updated!)
              image_url = ""
              
              # Priority 1: Mission Patch
              if target.get("mission_patches") and len(target["mission_patches"]) > 0:
                  image_url = target["mission_patches"][0]["image_url"]
              
              # Priority 2: Provider Logo (Fallback)
              # We check if the provider object exists and has a logo_url
              if not image_url and target.get("launch_service_provider"):
                  image_url = target["launch_service_provider"].get("logo_url", "")

              # 5. BOOSTER LOGIC
              stage = target.get("rocket", {}).get("launcher_stage", [{}])[0]
              landing = stage.get("landing", {})
              flight_n = stage.get("launcher_flight_number", 0)

              landing_status = "N/A"
              if landing and landing.get("attempt"):
                  if landing.get("success") is None: landing_status = "PENDING"
                  elif landing.get("success"): landing_status = "SUCCESS"
                  else: landing_status = "FAILED"
              elif landing: landing_status = "NO ATTEMPT"

              output = {
                  "mode": mode,
                  "name": target["name"],
                  "context": mission_context.upper(),
                  "agency": agency,
                  "provider": target["launch_service_provider"]["name"],
                  "pad": target["pad"]["location"]["name"],
                  "date": target["net"],
                  "status": target["status"]["abbrev"],
                  "image": image_url,
                  
                  # Minified Text Budget
                  "description": (raw_mission_desc or "").replace("\n", " ")[0:600],
                  "program_description": raw_program_desc.replace("\n", " ")[0:400] + "...",
                  
                  "rocket": target["rocket"]["configuration"]["name"],
                  "orbit": target["mission"]["orbit"]["name"] if target["mission"] and target["mission"]["orbit"] else "TBD",
                  "landing_status": landing_status,
                  "landing_loc": landing.get("location", {}).get("name", "Ocean") if landing and landing.get("location") else "N/A",
                  "flight_number": flight_n
              }

              with open("launch.json", "w") as f:
                  json.dump(output, f, separators=(',', ':'))
              
              print(f"SUCCESS: Generated minified JSON with Image: {image_url}")
          else:
              sys.exit(1)
              EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
