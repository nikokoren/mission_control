name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=1&mode=detailed&format=json" > upcoming.json
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          python3 - <<'EOF'
          import json
          import sys
          import random
          from datetime import datetime, timezone

          def load_json(filename):
              try:
                  with open(filename) as f:
                      data = json.load(f)
                      if "detail" in data: return None
                      return data["results"][0]
              except Exception:
                  return None

          upcoming = load_json("upcoming.json")
          previous = load_json("previous.json")

          if not upcoming and not previous:
              sys.exit(1)

          # --- TRIVIA BRAIN (Restored Full List) ---
          def get_rocket_fact(rocket_name):
              r_name = rocket_name.lower()
              facts = []

              if "falcon 9" in r_name:
                  facts = [
                      "...the Falcon 9's heat shield protecting the engines at the base is covered in a layer of cork.",
                      "...the Falcon 9 uses grid fins cast from a single piece of titanium so strong they are rarely replaced.",
                      "...the Falcon 9 cannot hover; it must perform a 'hoverslam' to hit zero velocity exactly at touchdown.",
                      "...the Falcon 9's flight computer uses 'voting' logic where three identical computers must agree.",
                      "...the Falcon 9's engines are arranged in an 'Octaweb' pattern to contain blast damage.",
                      "...the Falcon 9's fuel/oxygen are chilled to near freezing to densify them, packing more fuel in.",
                      "...the Falcon 9 uses 'friction stir welding' to fuse tanks without melting the metal.",
                      "...the Falcon 9 steers in space using cold nitrogen gas thrusters, creating the visible white puffs.",
                      "...the Falcon 9 must be pressurized with nitrogen during road transport to prevent collapsing.",
                      "...the Falcon 9's engines ignite using TEA-TEB, which creates the signature green flash."
                  ]
              elif "falcon heavy" in r_name:
                  facts = [
                      "...the Falcon Heavy's center core uses a 'LOXtopus' plumbing manifold for oxygen flow.",
                      "...at liftoff, the Falcon Heavy fires 27 engines simultaneously.",
                      "...the Falcon Heavy's center booster has thicker walls to withstand the side boosters' force.",
                      "...the Falcon Heavy's first payload (Tesla Roadster) crosses the path of Mars.",
                      "...the Falcon Heavy's 27 engines stagger ignition by milliseconds to reduce acoustic shock.",
                      "...Falcon Heavy side boosters are often converted flight-proven Falcon 9 boosters.",
                      "...hydraulic rams push the side boosters away to ensure safe separation.",
                      "...the center core throttles down immediately after launch to save fuel for later.",
                      "...the launch pad sound suppression system was upgraded to handle the Heavy's acoustic energy.",
                      "...the three exhaust plumes interact to create a massive single column of fire."
                  ]
              elif "vulcan" in r_name:
                  facts = [
                      "...the Vulcan Centaur's stainless steel upper tank is as thin as a dime and needs pressure to hold shape.",
                      "...the SMART reuse plan involves catching just the engines after splashdown.",
                      "...its solid rocket boosters (72ft) are the longest single-cast motors ever built.",
                      "...Vulcan uses Blue Origin BE-4 engines, relying on hardware from a competitor.",
                      "...Vulcan burns methane, producing a clean blue flame.",
                      "...Vulcan stages travel by ship (RocketShip) because they are too big for roads.",
                      "...the Centaur upper stage engine lineage dates back to the 1960s.",
                      "...advanced laser ignition research led to Vulcan's torch ignition system.",
                      "...the main tank uses an 'orthogrid' milled pattern for strength.",
                      "...mid-air helicopter capture of engines was scrapped for ocean recovery."
                  ]
              elif "new glenn" in r_name:
                  facts = [
                      "...New Glenn lands on a moving ship that drives forward to stabilize against waves.",
                      "...its fairing is large enough to fit two school buses side-by-side.",
                      "...it uses a 'tapped off' gas system, removing heavy helium bottles.",
                      "...the booster is engineered for 25 flights with minimal refurbishment.",
                      "...wing-like strakes allow it to glide back to the ship aerodynamically.",
                      "...methane fuel creates a transparent blue exhaust with visible shock diamonds.",
                      "...massive hydraulic fins at the top provide primary steering during glide.",
                      "...static fire tests are often skipped in favor of rigorous factory testing.",
                      "...it is assembled and rolled out vertically to protect payloads.",
                      "...upper stage engines use an efficient 'expander cycle' to spin pumps."
                  ]
              elif "electron" in r_name:
                  facts = [
                      "...Electron uses battery-powered electric motors to spin fuel pumps.",
                      "...it performs a 'battery hot-swap' in mid-air, dropping dead batteries.",
                      "...its Rutherford engines are almost entirely 3D printed in 24 hours.",
                      "...the black body is carbon fiber, light enough for two people to lift.",
                      "...a robot named 'Rosie' builds the carbon fiber tubes in 12 hours.",
                      "...a tiny 'kick stage' can coast for hours to precision-drop satellites.",
                      "...helicopter mid-air catch attempts were scrapped for ocean recovery.",
                      "...the exhaust sparkles because the nozzle liner erodes intentionally.",
                      "...it is only 4 feet wide; a person could almost wrap their arms around it.",
                      "...submerged helium bottles in the LOX tank are a complex engineering feat."
                  ]
              elif "soyuz" in r_name:
                  facts = [
                      "...engines are ignited by pyrotechnics held by wooden birch sticks.",
                      "...it hangs from a 'Tulip' structure rather than bolting to the pad.",
                      "...the launch command is ceremonially called 'Key to Start'.",
                      "...it is assembled horizontally and rolled out on wide-gauge rail tracks.",
                      "...launches to ISS aim for 51.6 degrees to avoid dropping boosters on China.",
                      "...LOX is warmed in winter to prevent valve freezing.",
                      "...crew buses stop for a traditional 'urination ritual' on the rear wheel.",
                      "...pumps run on hydrogen peroxide, separate from the main fuel.",
                      "...abort motors pull 14Gs, faster than the human eye can track.",
                      "...boosters separate in the famous 'Korolev Cross' pattern."
                  ]
              elif "ariane 6" in r_name:
                  facts = [
                      "...components arrive on 'Canopée', a ship with massive wingsails.",
                      "...it is assembled horizontally to save costs, unlike Ariane 5.",
                      "...the upper stage has a tiny engine to re-ignite and settle fuel.",
                      "...solid boosters are identical to the Vega-C first stage.",
                      "...a massive 'water curtain' suppresses acoustic energy at launch.",
                      "...the 8,200-ton gantry building rolls away on rails before launch.",
                      "...the nozzle rim is cooled by dumping turbopump exhaust into it.",
                      "...the SYLDA system encapsulates one satellite under another for dual launch.",
                      "...a pyrotechnic cord 'unzips' the fairing nose cone.",
                      "...launching from French Guiana gives a 1,000 mph rotation boost."
                  ]
              elif "long march 5" in r_name:
                  facts = [
                      "...nicknamed 'Fat-Five' because it exceeds the 3.35m rail tunnel limit.",
                      "...it is the first Chinese rocket transported by ship.",
                      "...foam insulation frost makes it change color from orange to white.",
                      "...engines use a nickel superalloy after a turbopump cracking issue.",
                      "...Wenchang launch site boosts payload due to equator proximity.",
                      "...the fairing is large enough to launch space station modules in one piece.",
                      "...ten liquid engines fire simultaneously at liftoff.",
                      "...it is a hybrid: hydrogen core with kerosene boosters.",
                      "...exhaust is mostly clean steam and kerosene, unlike older toxic hypergolics.",
                      "...future versions may use maglev rail transport to the pad."
                  ]
              elif "h3" in r_name:
                  facts = [
                      "...uses a complex 'expander bleed cycle' scaled up for main engines.",
                      "...uses automotive-grade electronics to cut costs.",
                      "...solid boosters separate using struts and drag, no separation rockets.",
                      "...the rocket is bolted to the platform and rolls 500m to the pad.",
                      "...the flight computer can trigger self-destruct if ignition fails.",
                      "...AI algorithms verify systems, reducing human crew needs.",
                      "...insulation is sprayed-on silicone instead of hand-glued cork.",
                      "...it can coast for hours to insert directly to GEO.",
                      "...Pogo suppression is built into the piping geometry.",
                      "...Tanegashima is considered the world's most beautiful launch site."
                  ]
              elif "lvm3" in r_name or "gslv" in r_name:
                  facts = [
                      "...nicknamed 'Bahubali' (Fat Boy) for its stubby appearance.",
                      "...solid boosters contain 200 tons of propellant each.",
                      "...core engines are improved versions of French Viking engines.",
                      "...boosters are tuned for lower vibration for human safety.",
                      "...the cryogenic upper stage was developed indigenously in India.",
                      "...water dumping keeps launch noise below 142 decibels.",
                      "...it is assembled vertically and rolled to the Second Launch Pad.",
                      "...manufacturing is eliminating hazardous chromium for green standards.",
                      "...liquid core engines ignite 110 seconds after liftoff.",
                      "...it is one of the most cost-efficient heavy launchers."
                  ]
              
              # Fallback for unknown rockets
              if not facts:
                  facts = [
                      "...rockets must reach 17,500 mph (7.8 km/s) to achieve orbit.",
                      "...the Kármán line (100km) is the boundary of space.",
                      "...over 85% of a rocket's mass is just fuel.",
                      "...launch windows are determined by orbital mechanics."
                  ]
              
              return random.choice(facts)

          # --- VISUAL BRAIN ---
          def get_rocket_image_url(rocket_name, status, landing_success, repo_url):
              r = rocket_name.lower()
              key = "generic"
              if "falcon 9" in r: key = "falcon9"
              elif "falcon heavy" in r: key = "falconheavy"
              elif "starship" in r or "super heavy" in r: key = "starship"
              elif "electron" in r: key = "electron"
              elif "atlas v" in r: key = "atlasv"
              elif "vulcan" in r: key = "vulcan"
              elif "delta iv heavy" in r: key = "delta4"
              elif "sls" in r or "space launch system" in r: key = "sls"
              elif "new glenn" in r: key = "newglenn"
              elif "ariane 6" in r: key = "ariane6"
              elif "vega" in r: key = "vega"
              elif "soyuz" in r: key = "soyuz"
              elif "proton" in r: key = "proton"
              elif "angara" in r: key = "angara"
              elif "long march 5" in r: key = "cz_5"
              elif "long march" in r: key = "cz_classic"
              elif "h-ii" in r or "h3" in r: key = "h3"
              elif "lvm3" in r or "gslv mk iii" in r: key = "lvm3"
              elif "pslv" in r: key = "pslv"
              elif "firefly" in r: key = "firefly"
              elif "minotaur" in r: key = "minotaur"

              suffix = "_idle"
              if status == "In Flight":
                  suffix = "_ascent"
              elif status in ["Success", "Failure", "Partial Failure"]:
                  if landing_success is True:
                      if key in ["falcon9", "falconheavy", "starship", "newglenn"]:
                          suffix = "_landed"
                      else:
                          key = "empty" 
                          suffix = ""
                  else:
                      key = "empty"
                      suffix = ""

              if key == "empty": filename = "empty.png"
              else: filename = f"{key}{suffix}.png"
              
              return f"{repo_url}/rockets/{filename}"

          # --- MAIN LOGIC ---
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          target = upcoming
          mode = "PRE_LAUNCH"

          if previous and upcoming:
              prev_date = parse_time(previous["net"])
              next_date = parse_time(upcoming["net"])
              hours_since_prev = (now - prev_date).total_seconds() / 3600
              hours_until_next = (next_date - now).total_seconds() / 3600

              if hours_since_prev < 6 and hours_until_next > 1:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          if target:
              if target["status"]["abbrev"] in ["Success", "Failure", "Partial Failure", "In Flight"]:
                  mode = "POST_LAUNCH"

              mission_context = "COMMERCIAL"
              if target.get("program") and len(target["program"]) > 0:
                  mission_context = target["program"][0]["name"]
              elif target.get("mission") and target["mission"].get("type"):
                  mission_context = target["mission"]["type"]

              agency = target["launch_service_provider"]["name"] 
              if target.get("mission") and target["mission"].get("agencies") and len(target["mission"]["agencies"]) > 0:
                  agency = target["mission"]["agencies"][0]["name"]
              agency = agency.replace("National Aeronautics and Space Administration", "NASA")
              agency = agency.replace("Space Exploration Technologies", "SpaceX")

              raw_mission_desc = ""
              if target.get("mission") and target["mission"].get("description"):
                  desc = target["mission"]["description"]
                  if "No description" not in desc: raw_mission_desc = desc
              
              raw_program_desc = ""
              if target.get("program") and len(target["program"]) > 0:
                  p_desc = target["program"][0].get("description", "")
                  if "No description" not in p_desc: raw_program_desc = p_desc

              image_url = ""
              if target.get("mission_patches") and len(target["mission_patches"]) > 0:
                  image_url = target["mission_patches"][0]["image_url"]
              if not image_url and target.get("launch_service_provider"):
                  image_url = target["launch_service_provider"].get("logo_url", "")

              pad_name = target["pad"]["name"] or "Unknown Pad"
              loc_name = target["pad"]["location"]["name"] or "Unknown Loc"
              pad_name = pad_name.replace("Space Launch Complex ", "SLC-").replace("Launch Complex ", "LC-")
              loc_short = loc_name.split(",")[0]
              full_location_str = f"{pad_name} @ {loc_short}"

              stage = target.get("rocket", {}).get("launcher_stage", [{}])[0]
              landing = stage.get("landing") or {}
              flight_n = stage.get("launcher_flight_number")
              landing_attempt = landing.get("attempt")
              landing_loc = landing.get("location", {}).get("name", "Unknown")
              landing_success = landing.get("success")
              landing_loc = landing_loc.replace("Of Course I Still Love You", "OCISLY").replace("Just Read The Instructions", "JRTI").replace("A Shortfall of Gravitas", "ASOG")

              footer_left = ""
              if mode == "PRE_LAUNCH":
                  if flight_n is not None:
                      if flight_n == 1: footer_left = "This is the maiden flight for this booster."
                      else: footer_left = f"This booster has flown {flight_n - 1} previous missions."
                  else: footer_left = "Booster history unavailable."

              footer_right = ""
              if landing_attempt is False: footer_right = "Expendable profile. No recovery."
              else:
                  if mode == "PRE_LAUNCH": footer_right = f"Targeting recovery at {landing_loc}."
                  else:
                      footer_left = "" 
                      if landing_success is True: footer_right = f"SUCCESS: Landed at {landing_loc}."
                      elif landing_success is False: footer_right = f"FAILURE: Missed landing at {landing_loc}."
                      else: footer_right = f"Landing pending at {landing_loc}."

              rocket_name = target["rocket"]["configuration"]["name"]
              try: the_fact = get_rocket_fact(rocket_name)
              except: the_fact = "Rockets are cool."

              # --- ROCKET IMAGE LOGIC ---
              # REPLACE THIS WITH YOUR ACTUAL REPO URL
              REPO_BASE = "https://raw.githubusercontent.com/YOUR_USER/YOUR_REPO/main"
              
              rocket_visual_url = get_rocket_image_url(
                  rocket_name, 
                  target["status"]["name"], 
                  landing_success, 
                  REPO_BASE
              )

              output = {
                  "mode": mode,
                  "name": target["name"],
                  "context": mission_context.upper(),
                  "agency": agency,
                  "provider": target["launch_service_provider"]["name"],
                  "location_str": full_location_str,
                  "date": target["net"],
                  "status": target["status"]["abbrev"],
                  "image": image_url,
                  "description": (raw_mission_desc or "").replace("\n", " ")[0:600],
                  "program_description": (raw_program_desc or "").replace("\n", " ")[0:400],
                  "rocket": rocket_name,
                  "orbit": target["mission"]["orbit"]["name"] if target["mission"] and target["mission"]["orbit"] else "TBD",
                  "footer_left": footer_left,
                  "footer_right": footer_right,
                  "rocket_fact": the_fact,
                  "rocket_visual": rocket_visual_url
              }

              with open("launch.json", "w") as f:
                  json.dump(output, f, separators=(',', ':'))
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
