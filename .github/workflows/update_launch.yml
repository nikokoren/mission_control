name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=1&mode=detailed&format=json" > upcoming.json
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          python3 - <<'EOF'
          import json
          import sys
          import random
          from datetime import datetime, timezone

          # --- CONFIG ---
          REPO_BASE = "https://raw.githubusercontent.com/YOUR_USER/YOUR_REPO/main"

          def load_json(filename):
              try:
                  with open(filename) as f:
                      data = json.load(f)
                      if "detail" in data: return None
                      return data["results"][0]
              except Exception:
                  return None

          upcoming = load_json("upcoming.json")
          previous = load_json("previous.json")

          if not upcoming and not previous:
              sys.exit(0)

          # --- TRIVIA BRAIN ---
          def get_rocket_fact(rocket_name):
              r_name = rocket_name.lower()
              facts = []
              
              if "falcon 9" in r_name:
                  facts = [
                      "...the Falcon 9's heat shield protecting the engines is covered in a layer of cork.",
                      "...the Falcon 9 uses grid fins cast from a single piece of titanium.",
                      "...the Falcon 9 cannot hover; it must perform a 'hoverslam' to hit zero velocity at touchdown.",
                      "...the Falcon 9's flight computer uses 'voting' logic where three identical computers must agree.",
                      "...the Falcon 9's engines are arranged in an 'Octaweb' pattern to contain blast damage.",
                      "...the Falcon 9's fuel/oxygen are chilled to near freezing to densify them.",
                      "...the Falcon 9 uses 'friction stir welding' to fuse tanks without melting the metal.",
                      "...the Falcon 9 steers in space using cold nitrogen gas thrusters.",
                      "...the Falcon 9 must be pressurized with nitrogen during road transport.",
                      "...the Falcon 9's engines ignite using TEA-TEB, creating the green flash."
                  ]
              elif "falcon heavy" in r_name:
                  facts = [
                      "...the Falcon Heavy's center core uses a 'LOXtopus' plumbing manifold.",
                      "...at liftoff, the Falcon Heavy fires 27 engines simultaneously.",
                      "...the Falcon Heavy's center booster has thicker walls to withstand the side boosters.",
                      "...the Falcon Heavy's first payload (Tesla Roadster) crosses the path of Mars.",
                      "...the Falcon Heavy's 27 engines stagger ignition to reduce acoustic shock.",
                      "...Falcon Heavy side boosters are often converted flight-proven Falcon 9 boosters.",
                      "...hydraulic rams push the side boosters away to ensure safe separation.",
                      "...the center core throttles down immediately after launch to save fuel.",
                      "...the launch pad sound suppression system was upgraded for the Heavy's energy.",
                      "...the three exhaust plumes interact to create a massive single column of fire."
                  ]
              elif "starship" in r_name:
                  facts = [
                      "...Starship is designed to be the first fully reusable orbital rocket.",
                      "...it uses Liquid Methane fuel, which can be synthesized on Mars.",
                      "...the Super Heavy booster has 33 Raptor engines.",
                      "...it catches the booster using 'Mechazilla' chopstick arms.",
                      "...it is made of stainless steel instead of carbon fiber."
                  ]
              elif "electron" in r_name:
                  facts = [
                      "...Electron uses battery-powered electric motors to spin fuel pumps.",
                      "...it performs a 'battery hot-swap' in mid-air, dropping dead batteries.",
                      "...its Rutherford engines are almost entirely 3D printed.",
                      "...the black body is carbon fiber, light enough for two people to lift.",
                      "...a robot named 'Rosie' builds the carbon fiber tubes in 12 hours.",
                      "...a tiny 'kick stage' can coast for hours to precision-drop satellites.",
                      "...helicopter mid-air catch attempts were scrapped for ocean recovery.",
                      "...the exhaust sparkles because the nozzle liner erodes intentionally.",
                      "...it is only 4 feet wide; a person could almost wrap their arms around it.",
                      "...submerged helium bottles in the LOX tank are a complex engineering feat."
                  ]
              elif "atlas v" in r_name:
                  facts = [
                      "...Atlas V has a 100% mission success rate for National Security payloads.",
                      "...it launched the Mars Perseverance Rover and New Horizons.",
                      "...the RD-180 main engine is a high-performance Russian engine.",
                      "...it can fly with anywhere from 0 to 5 solid rocket boosters.",
                      "...the Centaur upper stage uses balloon tanks that must stay pressurized."
                  ]
              elif "vulcan" in r_name:
                  facts = [
                      "...Vulcan's stainless steel upper tank is as thin as a dime.",
                      "...the SMART reuse plan involves catching just the engines.",
                      "...its solid rocket boosters (72ft) are the longest single-cast motors ever built.",
                      "...Vulcan uses Blue Origin BE-4 engines.",
                      "...Vulcan burns methane, producing a clean blue flame.",
                      "...Vulcan stages travel by ship (RocketShip) because they are too big for roads.",
                      "...the Centaur upper stage engine lineage dates back to the 1960s.",
                      "...advanced laser ignition research led to Vulcan's torch ignition system.",
                      "...the main tank uses an 'orthogrid' milled pattern for strength.",
                      "...mid-air helicopter capture of engines was scrapped for ocean recovery."
                  ]
              elif "new glenn" in r_name:
                  facts = [
                      "...New Glenn lands on a moving ship that drives forward to stabilize.",
                      "...its fairing fits two school buses side-by-side.",
                      "...it uses a 'tapped off' gas system, removing heavy helium bottles.",
                      "...the booster is engineered for 25 flights.",
                      "...wing-like strakes allow it to glide back to the ship.",
                      "...methane fuel creates a transparent blue exhaust.",
                      "...massive hydraulic fins at the top provide primary steering.",
                      "...static fire tests are often skipped in favor of factory testing.",
                      "...it is assembled and rolled out vertically.",
                      "...upper stage engines use an efficient 'expander cycle'."
                  ]
              elif "soyuz" in r_name:
                  facts = [
                      "...engines are ignited by pyrotechnics held by wooden birch sticks.",
                      "...it hangs from a 'Tulip' structure rather than bolting to the pad.",
                      "...the launch command is ceremonially called 'Key to Start'.",
                      "...it is assembled horizontally and rolled out on rail tracks.",
                      "...launches to ISS aim for 51.6 degrees to avoid dropping boosters on China.",
                      "...LOX is warmed in winter to prevent valve freezing.",
                      "...crew buses stop for a traditional 'urination ritual' on the rear wheel.",
                      "...pumps run on hydrogen peroxide, separate from the main fuel.",
                      "...abort motors pull 14Gs, faster than the human eye can track.",
                      "...boosters separate in the famous 'Korolev Cross' pattern."
                  ]
              elif "ariane 6" in r_name:
                  facts = [
                      "...components arrive on 'Canopée', a ship with massive wingsails.",
                      "...it is assembled horizontally to save costs.",
                      "...the upper stage has a tiny engine to re-ignite and settle fuel.",
                      "...solid boosters are identical to the Vega-C first stage.",
                      "...a massive 'water curtain' suppresses acoustic energy.",
                      "...the 8,200-ton gantry building rolls away on rails.",
                      "...the nozzle rim is cooled by dumping turbopump exhaust into it.",
                      "...the SYLDA system encapsulates one satellite under another.",
                      "...a pyrotechnic cord 'unzips' the fairing nose cone.",
                      "...launching from French Guiana gives a 1,000 mph rotation boost."
                  ]
              elif "long march" in r_name:
                  facts = [
                      "...Long March 5 is nicknamed 'Fat-Five' due to its width.",
                      "...it is the first Chinese rocket transported by ship.",
                      "...foam insulation frost makes it change color from orange to white.",
                      "...engines use a nickel superalloy after a cracking issue.",
                      "...Wenchang launch site boosts payload due to equator proximity.",
                      "...the fairing launched the Tiangong space station module.",
                      "...ten liquid engines fire simultaneously at liftoff.",
                      "...it is a hybrid: hydrogen core with kerosene boosters.",
                      "...exhaust is mostly clean steam and kerosene.",
                      "...future versions may use maglev rail transport."
                  ]
              elif "h3" in r_name:
                  facts = [
                      "...uses a complex 'expander bleed cycle' scaled up.",
                      "...uses automotive-grade electronics to cut costs.",
                      "...solid boosters separate using struts and drag.",
                      "...the rocket is bolted to the platform and rolls 500m.",
                      "...the computer can trigger self-destruct if ignition fails.",
                      "...AI algorithms verify systems, reducing human crew.",
                      "...insulation is sprayed-on silicone instead of cork.",
                      "...it can coast for hours to insert directly to GEO.",
                      "...Pogo suppression is built into the piping.",
                      "...Tanegashima is considered the world's most beautiful launch site."
                  ]
              elif "lvm3" in r_name:
                  facts = [
                      "...nicknamed 'Bahubali' (Fat Boy) for its stubby appearance.",
                      "...solid boosters contain 200 tons of propellant each.",
                      "...core engines are improved versions of French Viking engines.",
                      "...boosters are tuned for lower vibration for human safety.",
                      "...the cryogenic upper stage was developed indigenously.",
                      "...water dumping keeps launch noise below 142 decibels.",
                      "...it is assembled vertically and rolled to the Second Launch Pad.",
                      "...manufacturing is eliminating hazardous chromium.",
                      "...liquid core engines ignite 110 seconds after liftoff.",
                      "...it is one of the most cost-efficient heavy launchers."
                  ]
              
              if not facts:
                  facts = [
                      "...rockets must reach 17,500 mph (7.8 km/s) to achieve orbit.",
                      "...the Kármán line (100km) is the boundary of space.",
                      "...over 85% of a rocket's mass is just fuel.",
                      "...launch windows are determined by orbital mechanics."
                  ]
              
              return random.choice(facts)

          # --- VISUAL BRAIN ---
          def get_rocket_image_url(rocket_name, status, landing_success, repo_url):
              r = rocket_name.lower()
              key = "generic"
              if "falcon 9" in r: key = "falcon9"
              elif "falcon heavy" in r: key = "falconheavy"
              elif "starship" in r: key = "starship"
              elif "electron" in r: key = "electron"
              elif "atlas" in r: key = "atlasv"
              elif "vulcan" in r: key = "vulcan"
              elif "delta" in r: key = "delta4"
              elif "sls" in r: key = "sls"
              elif "new glenn" in r: key = "newglenn"
              elif "ariane" in r: key = "ariane6"
              elif "soyuz" in r: key = "soyuz"
              elif "long march" in r: key = "cz_classic"
              elif "h3" in r: key = "h3"
              
              suffix = "_idle"
              if status == "In Flight": suffix = "_ascent"
              elif status in ["Success", "Failure"]:
                  if landing_success:
                      if key in ["falcon9", "falconheavy", "starship"]: suffix = "_landed"
                      else: key, suffix = "empty", ""
                  else: key, suffix = "empty", ""

              if key == "empty": filename = "empty.png"
              else: filename = f"{key}{suffix}.png"
              return f"{repo_url}/rockets/{filename}"

          # --- TIME UTILS ---
          def get_countdown(dt_event):
              # Calculations must remain in UTC because GitHub Actions is UTC.
              now = datetime.now(timezone.utc)
              diff = dt_event - now
              
              if diff.total_seconds() < 0:
                  return "T- 00d 00h 00m"
              
              days = diff.days
              hours, remainder = divmod(diff.seconds, 3600)
              minutes, _ = divmod(remainder, 60)
              
              return f"T- {days:02}d {hours:02}h {minutes:02}m"

          now = datetime.now(timezone.utc)
          target = upcoming
          mode = "PRE_LAUNCH"

          # Mode Switching
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          if previous and upcoming:
              prev_dt = parse_time(previous["net"])
              next_dt = parse_time(upcoming["net"])
              
              hours_since = (now - prev_dt).total_seconds() / 3600
              hours_until = (next_dt - now).total_seconds() / 3600

              if hours_since < 6 and hours_until > 1:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          if target:
              if target["status"]["abbrev"] in ["Success", "Failure", "Partial Failure", "In Flight"]:
                  mode = "POST_LAUNCH"

              # --- CONTEXT ---
              mission_context = "COMMERCIAL"
              if target.get("program") and len(target["program"]) > 0:
                  mission_context = target["program"][0]["name"]
              elif target.get("mission") and target["mission"].get("type"):
                  mission_context = target["mission"]["type"]

              agency = target["launch_service_provider"]["name"] 
              if target.get("mission") and target["mission"].get("agencies") and len(target["mission"]["agencies"]) > 0:
                  agency = target["mission"]["agencies"][0]["name"]
              agency = agency.replace("National Aeronautics and Space Administration", "NASA")
              agency = agency.replace("Space Exploration Technologies", "SpaceX")

              # Descriptions
              raw_mission_desc = ""
              if target.get("mission") and target["mission"].get("description"):
                  desc = target["mission"]["description"]
                  if "No description" not in desc: raw_mission_desc = desc
              
              raw_program_desc = ""
              if target.get("program") and len(target["program"]) > 0:
                  p_desc = target["program"][0].get("description", "")
                  if "No description" not in p_desc: raw_program_desc = p_desc

              # --- LOCATION BUILDER ---
              pad = target["pad"]["name"] or "Unknown Pad"
              loc = target["pad"]["location"]["name"] or "Unknown"
              country_code = target["pad"]["location"].get("country_code", "")
              
              # Normalize Pad names
              if pad[0].isdigit(): pad = f"Pad {pad}"
              pad = pad.replace("Space Launch Complex ", "SLC-").replace("Launch Complex ", "LC-")
              
              # Extract Site Name (First part of comma list)
              loc_parts = loc.split(",")
              site_name = loc_parts[0].strip()
              
              # Smart Country Code
              if country_code == "USA": country_code = "" # Omit USA for brevity if preferred, or keep it.
              
              if country_code:
                  location_str = f"{pad}, {site_name}, {country_code}"
              else:
                  location_str = f"{pad}, {site_name}"

              # --- COUNTDOWN ---
              launch_dt_utc = parse_time(target["net"])
              countdown_str = get_countdown(launch_dt_utc)

              # --- FOOTER & RECOVERY ---
              stage = target.get("rocket", {}).get("launcher_stage", [{}])[0]
              landing = stage.get("landing") or {}
              flight_n = stage.get("launcher_flight_number")
              attempt = landing.get("attempt")
              success = landing.get("success")
              land_loc = landing.get("location", {}).get("name", "Unknown")
              
              land_loc = land_loc.replace("Of Course I Still Love You", "OCISLY").replace("Just Read The Instructions", "JRTI").replace("A Shortfall of Gravitas", "ASOG")

              footer_left = ""
              if mode == "PRE_LAUNCH":
                  if flight_n == 1: footer_left = "This is the maiden flight for this booster."
                  elif flight_n: footer_left = f"This booster has flown {flight_n - 1} previous missions."
                  else: footer_left = "Booster flight history is unavailable."

              footer_right = ""
              if attempt is False:
                  footer_right = "Expendable profile. No recovery attempted."
              else:
                  if mode == "PRE_LAUNCH":
                      if land_loc == "Unknown": footer_right = "Recovery attempt planned (Location Classified)."
                      else: footer_right = f"Targeting recovery at {land_loc}."
                  else:
                      footer_left = ""
                      if success: footer_right = f"SUCCESS: Landed at {land_loc}."
                      elif success is False: footer_right = f"FAILURE: Missed {land_loc}."
                      else: footer_right = f"Landing pending at {land_loc}."

              rocket_name = target["rocket"]["configuration"]["name"]
              try: the_fact = get_rocket_fact(rocket_name)
              except: the_fact = "Rockets are cool."

              output = {
                  "mode": mode,
                  "name": target["name"],
                  "context": mission_context.upper(),
                  "agency": agency,
                  "provider": target["launch_service_provider"]["name"],
                  "location_str": location_str,
                  "date": target["net"], # SENDING RAW ISO STRING FOR LIQUID
                  "countdown": countdown_str,
                  "status": target["status"]["abbrev"],
                  "image": target["image"] or "",
                  "description": (raw_mission_desc or "").replace("\n", " ")[0:600],
                  "program_description": (raw_program_desc or "").replace("\n", " ")[0:400],
                  "rocket": rocket_name,
                  "orbit": target["mission"]["orbit"]["name"] if target["mission"] and target["mission"]["orbit"] else "TBD",
                  "footer_left": footer_left,
                  "footer_right": footer_right,
                  "rocket_fact": the_fact,
                  "rocket_visual": get_rocket_image_url(rocket_name, target["status"]["name"], success, REPO_BASE)
              }

              with open("launch.json", "w") as f:
                  json.dump(output, f, separators=(',', ':'))
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
