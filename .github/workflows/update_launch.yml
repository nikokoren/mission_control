name: Update Rocket Launch Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=2&mode=detailed&hide_recent_previous=true&format=json" > upcoming.json
          curl -sS "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          python3 - <<'EOF'
          import json
          import sys
          import random
          from datetime import datetime, timezone

          # --- CONFIG ---
          # REPLACE THIS WITH YOUR REPO URL
          REPO_BASE = "https://raw.githubusercontent.com/nikokoren/mission_control/main"

          def load_json(filename):
              try:
                  with open(filename) as f:
                      data = json.load(f)
                      if "detail" in data: return None
                      if not data.get("results"): return None
                      return data["results"][0]
              except Exception:
                  return None

          upcoming = load_json("upcoming.json")
          previous = load_json("previous.json")

          if not upcoming and not previous:
              sys.exit(0)

          # --- TRIVIA BRAIN (TITANIUM EDITION) ---
          def get_rocket_fact(rocket_name):
              r_name = rocket_name.lower()
              
              general_facts = [
                  "Launch pad water deluge systems are primarily used for sound suppression to prevent acoustic waves from tearing the rocket apart.",
                  "To reach low Earth orbit, any rocket must travel at approximately 17,500 mph (28,000 km/h) sideways.",
                  "The Kármán line at 100km (62 miles) altitude is widely accepted as the boundary where space begins.",
                  "Rockets are mostly fuel; often over 85% of a launch vehicle's mass is propellant, leaving little room for payload.",
                  "Launch windows are strictly determined by orbital mechanics and collision avoidance requirements to hit a precise target.",
                  "The 'Max-Q' callout during launch refers to the moment of maximum dynamic pressure, where structural stress on the vehicle is highest.",
                  "Most rockets use a 'Gravity Turn', tilting slightly after liftoff to let gravity do the work of turning the rocket horizontal.",
                  "Hypergolic fuels ignite spontaneously upon contact with each other, making them reliable for restarting engines in space.",
                  "The 'pogo oscillation' is a dangerous vibration caused by fuel surging in the pipes, which can shake a rocket to pieces.",
                  "Specific Impulse (ISP) is the 'miles per gallon' of rocketry, measuring how efficiently an engine turns fuel into thrust.",
                  "Most rockets are painted white to reflect sunlight and keep the super-chilled cryogenic fuel from boiling off.",
                  "Astronauts on the International Space Station witness 16 sunrises and sunsets every single day.",
                  "Liquid Hydrogen fuel is so cold (-423°F) that it would instantly freeze air into a solid block of nitrogen ice.",
                  "A rocket launch is essentially a continuous controlled explosion that lasts for about eight minutes.",
                  "Ion thrusters used on satellites produce about as much force as the weight of a single sheet of paper."
              ]

              facts = []

              if "falcon 9" in r_name:
                  facts = [
                      "The Falcon 9's heat shield protecting the engines is covered in a layer of cork, similar to wine stoppers.",
                      "SpaceX's Falcon 9 uses grid fins cast from a single piece of titanium so strong they are rarely replaced.",
                      "The Falcon 9 cannot hover; it must perform a 'hoverslam' to hit zero velocity exactly at touchdown.",
                      "The Falcon 9's flight computer uses 'voting' logic where three identical computers must agree.",
                      "The Falcon 9's engines are arranged in an 'Octaweb' pattern to contain blast damage.",
                      "The Falcon 9's fuel and oxygen are chilled to near freezing to densify them, packing more fuel in.",
                      "The Falcon 9 uses 'friction stir welding' to fuse its aluminum-lithium tanks without melting the metal.",
                      "SpaceX's Falcon 9 steers in the vacuum of space using cold nitrogen gas thrusters, creating visible white puffs.",
                      "The Falcon 9 fairing halves are guided back to Earth using onboard thrusters and parafoils to be recovered from the ocean.",
                      "A single Falcon 9 fairing half costs approximately $3 million, making recovery a major cost saver.",
                      "The Falcon 9 is transported horizontally on the road, pressurized with nitrogen to keep the thin tanks rigid.",
                      "SpaceX can turn around a Falcon 9 booster for re-flight in under 3 weeks.",
                      "The soot on a landed Falcon 9 is rarely cleaned off fully, giving flight-proven boosters a distinct dirty look.",
                      "Falcon 9 uses sub-cooled propellants, meaning the fuel is chilled near its freezing point to increase density.",
                      "The 'Octaweb' engine arrangement is designed to protect surrounding engines if one Merlin engine explodes.",
                      "Falcon 9's landing legs contain single-use crush cores that absorb the impact of a hard landing.",
                      "SpaceX's Falcon 9 is the first orbital class rocket capable of reflight."                  
                  ]
              elif "falcon heavy" in r_name:
                  facts = [
                      "The Falcon Heavy's center core uses a complex 'LOXtopus' plumbing manifold to manage massive oxygen flow.",
                      "At liftoff, SpaceX's Falcon Heavy fires 27 engines simultaneously, a feat rarely attempted in history.",
                      "The Falcon Heavy's center booster is heavily reinforced with thicker tank walls to withstand the force of the side boosters.",
                      "Falcon Heavy's first payload, a Tesla Roadster, was thrown into an orbit that crosses the path of Mars.",
                      "The Falcon Heavy's 27 engines do not ignite instantly but are staggered by milliseconds to reduce acoustic shock.",
                      "SpaceX often converts flight-proven Falcon 9 boosters to serve as side boosters for the Falcon Heavy.",
                      "Massive hydraulic rams are used to push the Falcon Heavy side boosters away to ensure they don't collide during separation.",
                      "The Falcon Heavy's center core throttles down almost immediately after launch to save fuel for the later stages.",
                      "The launch pad's 'rainbird' sound suppression system had to be upgraded to handle Falcon Heavy's acoustic energy.",
                      "The three exhaust plumes of the Falcon Heavy interact to create a visible, massive single column of fire."
                  ]
              elif "starship" in r_name:
                  facts = [
                      "SpaceX's Starship is designed to be the first fully reusable orbital rocket in history.",
                      "Starship uses Liquid Methane fuel, which can theoretically be synthesized from the Martian atmosphere.",
                      "The Starship Super Heavy booster is powered by 33 separate Raptor engines firing in unison.",
                      "SpaceX catches the returning Super Heavy booster using massive 'Mechazilla' chopstick arms.",
                      "Starship uses ceramic hexagonal heat tiles that are mechanically attached to shift as the steel tank expands.",
                      "The Raptor engine uses a Full-Flow Staged Combustion cycle, a complex design only previously attempted by Soviet engineers.",
                      "Starship is pressurized with autogenous gas (gaseous methane/oxygen) instead of heavy helium bottles.",
                      "On the Super Heavy booster, the outer ring of 20 engines is fixed, while only the inner 13 can gimbal to steer.",
                      "Starship is constructed from stainless steel rather than carbon fiber to better withstand reentry heat."
                  ]
              elif "electron" in r_name:
                  facts = [
                      "Rocket Lab's Electron is the only orbital rocket that uses battery-powered electric motors to spin its fuel pumps.",
                      "Electron performs a 'battery hot-swap' in mid-air, physically dropping depleted battery packs to shed weight.",
                      "Rocket Lab's Rutherford engines are almost entirely 3D printed, allowing a verified engine to be built in 24 hours.",
                      "The Electron's body is black because it is made of carbon fiber composite, making it light enough for two people to lift.",
                      "Rocket Lab's Electron controllers run on C++ code, similar to the software powering many video games.",
                      "The Rutherford engine uses an electric motor the size of a soda can to spin its pumps at 40,000 RPM.",
                      "Electron's tanks are carbon composite liners overwrapped with carbon fiber, holding cryogenic fluid without a metal liner.",
                      "Rocket Lab names their Electron missions with puns, such as 'It's a Business Time' and 'Rocket Like a Hurricane'.",
                      "Electron's exhaust sometimes appears to sparkle because the ablative liner of the engine nozzle erodes intentionally.",
                      "Rocket Lab's Electron is surprisingly small, measuring only 4 feet wide."
                  ]
              elif "atlas v" in r_name:
                  facts = [
                      "ULA's Atlas V has a 100% mission success rate for National Security payloads.",
                      "The Atlas V launched NASA's Mars Perseverance Rover and the New Horizons Pluto probe.",
                      "Atlas V's RD-180 main engine is a high-performance Russian engine known for its efficiency.",
                      "ULA's Atlas V Centaur upper stage uses a 'common bulkhead'—a single metal sheet separating fuel and oxidizer.",
                      "Atlas V flies a remarkably steep trajectory compared to other rockets to get out of the thick atmosphere quickly.",
                      "The Atlas V 500 series flies with an offset fairing, making the rocket look slightly asymmetrical on the pad.",
                      "Atlas V can fly with anywhere from 0 to 5 solid rocket boosters depending on the payload weight."
                  ]
              elif "vulcan" in r_name:
                  facts = [
                      "The Vulcan Centaur's stainless steel upper tank is as thin as a dime.",
                      "The Vulcan SMART reuse plan involves catching just the engines after splashdown.",
                      "Vulcan's solid rocket boosters (72ft) are the longest single-cast motors ever built.",
                      "Vulcan uses Blue Origin BE-4 engines, relying on hardware from a competitor.",
                      "Vulcan burns methane, producing a clean blue flame.",
                      "Vulcan stages travel by ship (RocketShip) because they are too big for roads.",
                      "The Centaur upper stage engine lineage dates back to the 1960s.",
                      "Advanced laser ignition research led to Vulcan's torch ignition system.",
                      "The Vulcan main tank uses an 'orthogrid' milled pattern for strength.",
                      "Mid-air helicopter capture of Vulcan engines was scrapped for ocean recovery."
                  ]
              elif "new glenn" in r_name:
                  facts = [
                      "Blue Origin's New Glenn is designed to land on a moving ship that drives forward to stabilize against waves.",
                      "The New Glenn payload fairing is so voluminous that two full-sized school buses could fit inside side-by-side.",
                      "New Glenn's BE-4 engine uses an oxygen-rich staged combustion cycle, a method that requires advanced metallurgy.",
                      "The feather logo on Blue Origin's New Glenn represents the perfection of flight, inspired by Apollo 15.",
                      "Blue Origin's New Glenn first stage landing gear is passive, absorbing impact without complex hydraulics.",
                      "New Glenn uses a 'tapped off' gas system to pressurize tanks, eliminating the need for heavy helium bottles.",
                      "The New Glenn booster uses wing-like strakes to provide aerodynamic lift during its return glide.",
                      "Blue Origin often skips static fire tests for New Glenn, trusting their rigorous factory testing process.",
                      "New Glenn is assembled vertically in a massive hangar to protect delicate satellite payloads.",
                      "The New Glenn upper stage engines use an efficient 'expander cycle' to spin pumps."
                  ]
              elif "soyuz" in r_name:
                  facts = [
                      "Roscosmos's Soyuz engines are ignited by pyrotechnics held in place by birch or hazel wood sticks.",
                      "The Soyuz rocket hangs suspended in a 'Tulip' structure rather than bolting to the pad.",
                      "The official Soyuz launch command is ceremonially called 'Key to Start', a holdover from early designs.",
                      "Soyuz fuel is actually 'Syntin', a synthetic kerosene chemically modified for higher performance.",
                      "The Soyuz launch key is a small command tool inserted into a bunker console, not a car-style ignition key.",
                      "The Soyuz 'periscope' used by the crew for docking alignment is a literal system of mirrors sticking out of the capsule.",
                      "Soyuz crew buses stop for a traditional 'urination ritual' on the rear wheel on the way to the pad.",
                      "The Soyuz abort tower motors pull 14Gs, moving the crew away faster than the human eye can track.",
                      "Soyuz boosters separate in the famous 'Korolev Cross' pattern caused by residual oxygen venting."
                  ]
              elif "ariane 6" in r_name:
                  facts = [
                      "ESA's Ariane 6 components are transported to French Guiana on a ship called 'Canopée' that uses massive wingsails.",
                      "Ariane 6 is assembled horizontally to save time and money, unlike its predecessor Ariane 5.",
                      "The Ariane 6 upper stage features a tiny auxiliary engine that re-ignites to settle the fuel in orbit.",
                      "Ariane 6's Vinci engine can restart up to 5 times in orbit, allowing it to de-orbit itself to prevent space debris.",
                      "The water deluge system at the Ariane 6 launch site dumps 400 cubic meters of water in just 30 seconds.",
                      "Ariane 6 uses Laser Ignition Systems for its engines, reducing weight and increasing reliability.",
                      "The Ariane 6 nozzle rim is cooled by dumping exhaust from the turbopump directly into it.",
                      "Launching Ariane 6 from French Guiana provides a 'slingshot' speed boost of nearly 1,000 mph due to Earth's rotation."
                  ]
              elif "long march 5" in r_name:
                  facts = [
                      "CASC's Long March 5 is nicknamed 'Fat-Five' because its diameter broke the limits of Chinese railway tunnels.",
                      "Long March 5 is the first Chinese rocket that must be transported by ship to the launch site.",
                      "The Long March 5 core stage is so cold after fueling that it creates its own weather system of fog.",
                      "The Long March 5 fairing was large enough to launch the Tiangong space station core module in one piece."                      "Long March 5 is a hybrid rocket, using a hydrogen core stage surrounded by kerosene boosters."
                  ]
              elif "long march 7" in r_name:
                  facts = [
                      "CASC's Long March 7 is the primary cargo truck for the Tiangong Space Station.",
                      "Long March 7 uses non-toxic kerosene/LOX, replacing older hypergolic rockets.",
                      "Long March 7 is designed to be weather-proof, able to launch even in moderate rain.",
                      "Long March 7 launches exclusively from the coastal Wenchang Space Launch Site."
                  ]
              elif "delta" in r_name:
                  facts = [
                      "Delta IV Heavy sets itself on fire at launch to burn off excess hydrogen.",
                      "Delta IV Heavy was the most powerful rocket in the world before Falcon Heavy.",
                      "Delta IV Heavy launches massive NRO spy satellites.",
                      "Delta IV Heavy uses three Common Booster Cores bolted together.",
                      "Delta IV Heavy engines run on liquid hydrogen, creating a clear flame."
                  ]
              elif "pslv" in r_name:
                  facts = [
                      "ISRO's PSLV is known as the 'Workhorse of India' for its high reliability.",
                      "PSLV launched India's first mission to Mars (Mangalyaan).",
                      "PSLV alternates solid and liquid stages (Solid-Liquid-Solid-Liquid).",
                      "PSLV set a world record by launching 104 satellites in a single mission.",
                      "PSLV uses strap-on boosters that look like miniature rockets."
                  ]
              elif "vega" in r_name:
                  facts = [
                      "ESA's Vega is named after the second brightest star in the northern hemisphere.",
                      "Vega is composed mostly of solid-fuel stages.",
                      "Vega launches from the same jungle spaceport as Ariane 6.",
                      "Vega is designed specifically for small scientific and earth observation satellites."
                  ]
              elif "h3" in r_name:
                  facts = [
                      "H3 uses a complex 'expander bleed cycle' scaled up for main engines.",
                      "H3 uses automotive-grade electronics to cut costs.",
                      "H3 solid boosters separate using struts and drag, no separation rockets.",
                      "The H3 rocket is bolted to the platform and rolls 500m to the pad.",
                      "The H3 flight computer can trigger self-destruct if ignition fails.",
                      "H3 AI algorithms verify systems, reducing human crew needs.",
                      "H3 insulation is sprayed-on silicone instead of hand-glued cork.",
                      "H3 can coast for hours to insert directly to Geostationary Orbit.",
                      "H3 Pogo suppression is built into the piping geometry.",
                      "H3 launches from Tanegashima, considered the world's most beautiful launch site."
                  ]
              elif "lvm3" in r_name:
                  facts = [
                      "ISRO's LVM3 is affectionately nicknamed 'Bahubali' or 'Fat Boy' due to its stubby appearance.",
                      "The S200 solid boosters on ISRO's LVM3 use a flex-nozzle control system where the entire nozzle pivots.",
                      "ISRO paints the LVM3 white to reflect tropical sunlight and keep the fuel tanks cool on the launch pad.",
                      "The LVM3's solid boosters are among the largest in the world, each containing 200 tons of propellant.",
                      "ISRO's LVM3 cryogenic upper stage engine was developed entirely indigenously in India.",
                      "The LVM3 launch pad uses a water suppression system that keeps the acoustic energy below 142 decibels.",
                      "ISRO's LVM3 liquid core engines do not ignite until the rocket is already 110 seconds into the flight."
                  ]
              elif "gslv" in r_name:
                  facts = [
                      "GSLV Mk II is affectionately nicknamed the 'Naughty Boy' by ISRO due to early reliability issues.",
                      "The GSLV Mk II features an indigenously developed Cryogenic Upper Stage (CUS).",
                      "GSLV Mk II uses four liquid strap-on boosters derived from the PSLV's core stage.",
                      "The GSLV Mk II is designed primarily to launch INSAT communication satellites."
                  ]
              elif "proton" in r_name:
                  facts = [
                      "The Proton rocket uses toxic hypergolic propellants that ignite on contact.",
                      "Proton has launched every Soviet and Russian space station module, including Mir.",
                      "The Proton rocket is transported horizontally by rail and erected at the launch pad.",
                      "Proton uses a Briz-M upper stage that can restart multiple times."
                  ]
              elif "angara" in r_name:
                  facts = [
                      "Angara is the first all-new launch vehicle family developed by Russia since the Soviet era.",
                      "Angara uses Universal Rocket Modules (URMs) that can be strapped together.",
                      "Angara burns clean kerosene and oxygen, replacing the toxic Proton rocket."
                  ]
              elif "antares" in r_name:
                  facts = [
                      "Antares is designed specifically to launch the Cygnus cargo spacecraft to the ISS.",
                      "The Antares first stage was built in Ukraine, while its engines were originally Russian.",
                      "Antares launches from Wallops Island, Virginia, visible to the US East Coast."
                  ]
              elif "minotaur" in r_name:
                  facts = [
                      "Minotaur rockets are built from decommissioned Minuteman and Peacekeeper ICBM stages.",
                      "The Minotaur I can be assembled and launched in weeks due to its solid-fuel design.",
                      "Minotaur launches often look different because they use a yellow-flamed solid propellant."
                  ]
              elif "firefly" in r_name:
                  facts = [
                      "Firefly Alpha's Reaver engines use a 'combustion tap-off' cycle, a rare design.",
                      "The Firefly Alpha airframe is built entirely from carbon-fiber composite.",
                      "Firefly Alpha launched the 'Victus Nox' mission with just 27 hours of notice."
                  ]
              elif "sls" in r_name:
                  facts = [
                      "NASA's SLS Block 1 produces 8.8 million pounds of thrust, which is 15% more power than the legendary Saturn V.",
                      "SLS uses four RS-25 engines that are refurbished veterans from the Space Shuttle program.",
                      "The SLS solid boosters are five-segment versions of the Shuttle boosters, adding 25% more impulse.",
                      "SLS stands taller than the Statue of Liberty but slightly shorter than Saturn V.",
                      "The core stage uses friction stir welding for its barrel sections, creating stronger bonds.",
                      "SLS is capable of sending the Orion spacecraft and four astronauts directly to the Moon.",
                      "The propellant for the SLS solid boosters has the consistency of a rubber eraser."
                  ]
              elif "long march 2f" in r_name:
                  facts = [
                      "The Long March 2F is nicknamed 'Shenjian' (Divine Arrow) and is used for China's crewed missions.",
                      "Long March 2F features an advanced fault monitoring system to trigger the launch escape tower.",
                      "Unlike other Long March variants, the 2F is assembled vertically and rolled out upright.",
                      "Long March 2F has achieved a perfect success rate, launching every Chinese astronaut since 2003.",
                      "Crew members can exit the launch pad via a canvas slide into an underground shelter."
                  ]
              elif "long march 3b" in r_name:
                  facts = [
                      "Long March 3B is China's primary workhorse for high-orbit Geostationary missions.",
                      "Long March 3B uses hypergolic propellants which can be stored at room temperature.",
                      "Long March 3B launched the Chang'e 3 lunar lander and Yutu rover to the Moon.",
                      "The Long March 3B launches from Xichang, meaning spent stages often fall over land.",
                      "Long March 3B was crucial for building China's BeiDou Navigation Satellite System."
                  ]
              elif "nuri" in r_name:
                  facts = [
                      "Unlike its predecessor Naro-1, every component of Nuri was built in South Korea.",
                      "Nuri is designed to launch 1.5-ton payloads into Sun-Synchronous Orbit.",
                      "South Korea plans to use Nuri technology to launch a lunar lander by 2031.",
                      "Nuri's launch complex at Naro Space Center was built specifically for this rocket.",
                      "Nuri successfully deployed a performance verification satellite and CubeSats in 2022."
                  ]
              elif "ceres" in r_name:
                  facts = [
                      "Ceres-1 is named after the first asteroid discovered, the Roman goddess of agriculture.",
                      "Ceres-1 can be launched from a mobile transporter or a sea-launch barge.",
                      "The Ceres-1S is a sea-launched variant that debuted from a barge in the Yellow Sea.",
                      "Galactic Energy was the second private Chinese firm to ever reach orbit.",
                      "Ceres-1 can lift about 400 kg to Low Earth Orbit."
                  ]
              
              if not facts:
                  pool = general_facts
              else:
                  pool = facts + general_facts
              
              return random.choice(pool)

# --- VISUAL BRAIN (FIXED ARGS) ---
          def get_rocket_image_url(rocket_name, status, landing_success, mission_type, mission_name, repo_url):
              r = rocket_name.lower()
              m_type = str(mission_type).lower()
              m_name = str(mission_name).lower()
              
              key = "generic"
              
              if rocket_name == "generic":
                  key = "generic"
              else:
                  # 1. SpaceX Special Logic
                  if "falcon 9" in r:
                      if "human" in m_type or "crew" in m_name or "axiom" in m_name or "polaris" in m_name:
                          key = "falcon9_crew"
                      else:
                          key = "falcon9"
                  elif "falcon heavy" in r: key = "falconheavy"
                  elif "starship" in r: key = "starship"

              # 1. Heavy / Super Heavy
              
                  elif "sls" in r: key = "sls"
                  elif "new glenn" in r: key = "newglenn"
                  elif "delta iv heavy" in r: key = "delta4"
                  elif "long march 5" in r: key = "cz_5"  
                  elif "lvm3" in r: key = "lvm3"

              # 2. Medium / Standard
                  elif "falcon 9" in r: key = "falcon9"
                  elif "vulcan" in r: key = "vulcan"
                  elif "atlas" in r: key = "atlasv"
                  elif "ariane" in r: key = "ariane6"
                  elif "h3" in r: key = "h3"
                  elif "soyuz" in r: key = "soyuz"
                  elif "antares" in r: key = "antares"
              
              # 3. Chinese Variants
                  elif "long march 7" in r: key = "cz_7"
                  elif "long march 2f" in r: key = "cz_2f"
                  elif "long march 3b" in r: key = "cz_3b"
                  elif "long march" in r: key = "cz_classic" 
              
              # 4. Small / Light
                  elif "electron" in r: key = "electron"
                  elif "firefly" in r: key = "firefly"
                  elif "minotaur" in r: key = "minotaur"
                  elif "pslv" in r: key = "pslv"
                  elif "vega" in r: key = "vega"
                  elif "nuri" in r: key = "nuri"
                  elif "ceres" in r: key = "ceres"
              
              suffix = "_idle"
              if status == "In Flight" or status == "AWAITING CONFIRMATION":
                  suffix = "_ascent"
              elif status in ["Success", "Failure", "Partial Failure"]:
                  if landing_success and key in ["falcon9", "falconheavy", "starship", "newglenn"]:
                      suffix = "_landed"
                  else:
                      key = "empty" 
                      suffix = ""
              
              if key == "empty": return f"{repo_url}/rockets/empty.png"
              return f"{repo_url}/rockets/{key}{suffix}.png"

          # --- COUNTDOWN ---
          def get_countdown(dt_event):
              now = datetime.now(timezone.utc)
              diff = dt_event - now
              if diff.total_seconds() < 0: return "T- 00h 00m"
              total_seconds = int(diff.total_seconds())
              hours, remainder = divmod(total_seconds, 3600)
              minutes, _ = divmod(remainder, 60)
              return f"T- {hours:02}h {minutes:02}m"

          # --- MAIN LOGIC ---
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          target = upcoming
          mode = "PRE_LAUNCH"

          if previous and upcoming:
              prev_dt = parse_time(previous["net"])
              next_dt = parse_time(upcoming["net"])
              hours_since = (now - prev_dt).total_seconds() / 3600
              hours_until = (next_dt - now).total_seconds() / 3600

              if hours_since < 12 and hours_until > 1:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          if target:
              target_dt = parse_time(target["net"])
              seconds_since_t0 = (now - target_dt).total_seconds()
              
              # API STATUS CHECK
              api_status = target["status"]["abbrev"]
              is_final = api_status in ["Success", "Failure", "Partial Failure", "In Flight"]
              
              if is_final:
                  mode = "POST_LAUNCH"
              elif seconds_since_t0 > 600:
                  mode = "POST_LAUNCH"
                  target["status"]["abbrev"] = "PENDING"
                  target["status"]["name"] = "AWAITING CONFIRMATION"

              mission_context = "COMMERCIAL"
              if target.get("program") and len(target["program"]) > 0:
                  mission_context = target["program"][0]["name"]
              elif target.get("mission") and target["mission"].get("type"):
                  mission_context = target["mission"]["type"]

              provider = target["launch_service_provider"]["name"]
              provider = provider.replace("China Aerospace Science and Technology Corporation", "CASC")
              provider = provider.replace("National Aeronautics and Space Administration", "NASA")
              provider = provider.replace("Space Exploration Technologies", "SpaceX")
              
              agency = "" 
              if target.get("mission") and target["mission"].get("agencies") and len(target["mission"]["agencies"]) > 0:
                  raw_agency = target["mission"]["agencies"][0]["name"]
                  raw_agency = raw_agency.replace("China Aerospace Science and Technology Corporation", "CASC")
                  raw_agency = raw_agency.replace("National Aeronautics and Space Administration", "NASA")
                  if raw_agency != provider:
                      agency = raw_agency

              raw_mission_desc = ""
              if target.get("mission") and target["mission"].get("description"):
                  desc = target["mission"]["description"]
                  if "No description" not in desc: raw_mission_desc = desc
              
              raw_program_desc = ""
              if target.get("program") and len(target["program"]) > 0:
                  p_desc = target["program"][0].get("description", "")
                  if "No description" not in p_desc: raw_program_desc = p_desc

              image_url = ""
              if target.get("mission_patches") and len(target["mission_patches"]) > 0:
                  image_url = target["mission_patches"][0]["image_url"]
              if not image_url and target.get("launch_service_provider"):
                  image_url = target["launch_service_provider"].get("logo_url", "")

              pad_name = target["pad"]["name"] or "Unknown Pad"
              loc_name = target["pad"]["location"]["name"] or "Unknown Loc"
              country_code = target["pad"]["location"].get("country_code", "")
              
              pad_name = pad_name.replace("Space Launch Complex ", "SLC-").replace("Launch Complex ", "LC-")
              if pad_name.isdigit(): pad_name = f"Pad {pad_name}"
              
              loc_short = loc_name.split(",")[0].strip()
              if country_code: full_location_str = f"{pad_name} @ {loc_short}, {country_code}"
              else: full_location_str = f"{pad_name} @ {loc_short}"

              stage = {}
              if target.get("rocket", {}).get("launcher_stage"):
                  stages = target["rocket"]["launcher_stage"]
                  if isinstance(stages, list) and len(stages) > 0:
                      stage = stages[0]
              
              landing = stage.get("landing") or {}
              flight_n = stage.get("launcher_flight_number")
              landing_attempt = landing.get("attempt")
              landing_loc = landing.get("location", {}).get("name", "Unknown")
              landing_success = landing.get("success")
              
              landing_loc = landing_loc.replace("Of Course I Still Love You", "OCISLY").replace("Just Read The Instructions", "JRTI").replace("A Shortfall of Gravitas", "ASOG")

              footer_left = ""
              footer_right = ""

              if landing_attempt is not True: 
                  footer_left = "" 
                  footer_right = "Single-use configuration. No recovery planned."
              else:
                  if mode == "PRE_LAUNCH":
                      if flight_n: 
                          if flight_n == 1: footer_left = "Maiden flight for this booster."
                          else: footer_left = f"Booster flight #{flight_n}."
                      else:
                          footer_left = "Booster identity classified/unavailable."
                  
                  if mode == "PRE_LAUNCH":
                      if landing_loc == "Unknown": footer_right = "Recovery planned (Location TBD)."
                      else: footer_right = f"Targeting recovery at {landing_loc}."
                  else:
                      footer_left = "" 
                      if target["status"]["abbrev"] == "PENDING":
                          footer_right = "Launch window open. Status pending confirmation."
                      elif landing_success is True: 
                          footer_right = f"SUCCESS: Landed at {landing_loc}."
                      elif landing_success is False: 
                          footer_right = f"FAILURE: Missed {landing_loc}."
                      else: 
                          footer_right = f"Landing pending at {landing_loc}."

              rocket_name = target["rocket"]["configuration"]["name"]
              try: the_fact = get_rocket_fact(rocket_name)
              except: the_fact = "Rockets are cool."

              vis_status = target["status"]["name"] if target["status"]["abbrev"] != "PENDING" else "AWAITING CONFIRMATION"
              rocket_visual_url = get_rocket_image_url(rocket_name, vis_status, landing_success, REPO_BASE)
              
              # Generic Fallback
              generic_visual_url = get_rocket_image_url("generic", vis_status, landing_success, REPO_BASE)

              # Timestamps
              date_ts = int(target_dt.timestamp())
              win_start_ts = date_ts
              win_end_ts = date_ts
              if target.get("window_start"):
                   win_start_ts = int(parse_time(target["window_start"]).timestamp())
              if target.get("window_end"):
                   win_end_ts = int(parse_time(target["window_end"]).timestamp())

              m_name = target["name"].split(" | ")[-1]
              if "Unknown Payload" in m_name: m_name = rocket_name

              output = {
                  "mode": mode,
                  "name": m_name,
                  "context": mission_context.upper(),
                  "agency": agency,
                  "provider": provider,
                  "location_str": full_location_str,
                  "date": target["net"],
                  "date_ts": date_ts,
                  "window_start_ts": win_start_ts,
                  "window_end_ts": win_end_ts,
                  "countdown": get_countdown(target_dt),
                  "status": target["status"]["abbrev"],
                  "image": image_url,
                  "description": (raw_mission_desc or "").replace("\n", " ")[0:600],
                  "program_description": (raw_program_desc or "").replace("\n", " ")[0:400],
                  "rocket": rocket_name,
                  "orbit": target["mission"]["orbit"]["name"] if target.get("mission") else "TBD",
                  "footer_left": footer_left,
                  "footer_right": footer_right,
                  "rocket_fact": the_fact,
                  "rocket_visual": rocket_visual_url,
                  "generic_visual": generic_visual_url
              }

              with open("launch.json", "w") as f:
                  json.dump(output, f, separators=(',', ':'))
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
