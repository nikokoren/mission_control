name: Update Rocket Launch Data

on:
  schedule:
    # Run every 10 minutes to catch delays and landing updates quickly
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allows you to force-run it manually from the Actions tab

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and Smart-Process Data
        run: |
          # 1. Fetch NEXT launch
          curl -s "https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=1&mode=detailed&format=json" > upcoming.json
          
          # 2. Fetch PREVIOUS launch (to capture recent successes)
          curl -s "https://ll.thespacedevs.com/2.2.0/launch/previous/?limit=1&mode=detailed&format=json" > previous.json

          # 3. Python Logic: Decide which one to show & format the data
          python3 -c '
          import json
          from datetime import datetime, timezone

          # Load Data
          try:
              with open("upcoming.json") as f:
                  upcoming = json.load(f)["results"][0]
          except (IndexError, KeyError):
              upcoming = None

          try:
              with open("previous.json") as f:
                  previous = json.load(f)["results"][0]
          except (IndexError, KeyError):
              previous = None

          # If API fails completely, exit (prevents overwriting valid data with empty file)
          if not upcoming and not previous:
              exit(1)

          # Helper to parse time
          def parse_time(t_str):
              return datetime.strptime(t_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)

          now = datetime.now(timezone.utc)
          
          # Default to upcoming
          target = upcoming
          mode = "PRE_LAUNCH"

          # LOGIC ENGINE
          if previous and upcoming:
              prev_date = parse_time(previous["net"])
              next_date = parse_time(upcoming["net"])
              
              hours_since_prev = (now - prev_date).total_seconds() / 3600
              hours_until_next = (next_date - now).total_seconds() / 3600

              # Rule 1: "The 6-Hour Window"
              # If previous launch was recent (<6h) and next one isn't immediate (>1h), show previous.
              if hours_since_prev < 6 and hours_until_next > 1:
                  target = previous
                  mode = "POST_LAUNCH"
              else:
                  target = upcoming
                  mode = "PRE_LAUNCH"

          # Rule 2: "The Zombie Fix (Status Override)"
          # If the target we selected says "Success" or "Failure", it is NOT a pre-launch.
          # This fixes cases where a launch is technically "upcoming" in the API but has already launched.
          status_abbrev = target["status"]["abbrev"]
          if status_abbrev in ["Success", "Failure", "Partial Failure"]:
              mode = "POST_LAUNCH"

          # EXTRACT DATA FIELDS
          # Handle potential nulls safely
          stage = target.get("rocket", {}).get("launcher_stage", [{}])[0]
          landing = stage.get("landing", {})
          
          # Logic for Landing Status
          landing_status = "N/A"
          if landing and landing.get("attempt"):
              if landing.get("success") is None:
                  landing_status = "PENDING"
              elif landing.get("success"):
                  landing_status = "SUCCESS"
              else:
                  landing_status = "FAILED"
          elif landing:
              landing_status = "NO ATTEMPT"

          # Construct the clean JSON
          output = {
              "mode": mode,
              "name": target["name"],
              "provider": target["launch_service_provider"]["name"],
              "pad": target["pad"]["location"]["name"],
              "date": target["net"],
              "status": target["status"]["abbrev"],
              # Truncate description to 250 chars to fit TRMNL memory
              "description": (target["mission"]["description"] or "No description available.")[0:250] + "...",
              "rocket": target["rocket"]["configuration"]["name"],
              "orbit": target["mission"]["orbit"]["name"] if target["mission"] and target["mission"]["orbit"] else "TBD",
              "landing_status": landing_status,
              "landing_loc": landing.get("location", {}).get("name", "Ocean") if landing and landing.get("location") else "N/A",
              "flight_proven": stage.get("reused", False)
          }

          with open("launch.json", "w") as f:
              json.dump(output, f, indent=2)
          '

      - name: Commit and Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add launch.json
          # Only commit if the file has actually changed
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update launch data" && git push)
